<!DOCTYPE html>
<html>
<head>
    <title>Download Status</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        #ongoing-downloads {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        #ongoing-downloads h2 {
            margin-top: 0;
            color: #333;
        }
        .progress-container {
            margin: 15px 0;
        }
        progress {
            width: 100%;
            height: 30px;
            border-radius: 4px;
            border: none;
        }
        progress::-webkit-progress-bar {
            background-color: #e0e0e0;
            border-radius: 4px;
        }
        progress::-webkit-progress-value {
            background-color: #4CAF50;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        progress::-moz-progress-bar {
            background-color: #4CAF50;
            border-radius: 4px;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        #progress-percentage {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .done-indicator {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
            display: none;
        }
        .done-indicator.show {
            display: inline-block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        #status {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Download Status</h1>
    <button onclick="window.location.href='/logout'">Logout</button>

    <div id="ongoing-downloads" style="display: none;">
        <h2>Ongoing Downloads</h2>
        <div class="progress-container">
            <progress id="download-progress" value="0" max="100"></progress>
            <div class="progress-info">
                <span id="progress-percentage">0%</span>
                <span class="done-indicator" id="done-indicator">âœ“ Complete!</span>
            </div>
        </div>
    </div>

    <div id="status">Loading...</div>

    <script>
        let redirecting = false;  // Add flag to prevent multiple redirects

        // HTML escape function to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateStatus() {
            if (redirecting) return;  // Skip update if already redirecting

            fetch('{{ STATUS_PATH }}', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401 && !redirecting) {
                    redirecting = true;
                    // Only redirect if we're not already at the login page
                    if (!window.location.pathname.includes('/login')) {
                        window.location.href = '/login';
                    }
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('status').innerHTML = `
                        <h2>Current Status</h2>
                        <pre>${escapeHtml(data.current_status)}</pre>
                        <h2>Queue</h2>
                        <pre>${escapeHtml(JSON.stringify(data.queue, null, 2))}</pre>
                        <h2>Downloaded Files</h2>
                        <pre>${escapeHtml(JSON.stringify(data.downloaded_files, null, 2))}</pre>
                    `;

                    const percentage = data.current_download_percentage;
                    const progressBar = document.getElementById('download-progress');
                    const progressText = document.getElementById('progress-percentage');
                    const doneIndicator = document.getElementById('done-indicator');

                    if (percentage > 0) {
                        document.getElementById('ongoing-downloads').style.display = 'block';
                        progressBar.value = percentage;
                        progressText.textContent = Math.round(percentage) + '%';

                        // Show "Done" indicator when complete
                        if (percentage >= 100) {
                            progressText.style.display = 'none';
                            doneIndicator.classList.add('show');
                        } else {
                            progressText.style.display = 'inline-block';
                            doneIndicator.classList.remove('show');
                        }
                    } else {
                        document.getElementById('ongoing-downloads').style.display = 'none';
                        doneIndicator.classList.remove('show');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Don't redirect on network errors
            });
        }

        // Initial update
        updateStatus();
        
        // Update every 1 second, but only if we're not at the login page
        const intervalId = setInterval(() => {
            if (!window.location.pathname.includes('/login')) {
                updateStatus();
            }
        }, 1000);
    </script>
</body>
</html>